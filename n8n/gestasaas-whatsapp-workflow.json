{
  "name": "GestaSaaS - WhatsApp Database Manager",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatsapp-webhook",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-whatsapp",
      "name": "Webhook WhatsApp",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "whatsapp-gestasaas"
    },
    {
      "parameters": {
        "functionCode": "// Extrair e validar nÃºmero do WhatsApp\nconst body = $input.all()[0].json.body;\n\n// Verificar se Ã© uma mensagem vÃ¡lida\nif (!body || !body.data || !body.data.key || !body.data.key.remoteJid) {\n  return {\n    error: true,\n    message: 'Dados invÃ¡lidos recebidos',\n    data: body\n  };\n}\n\nconst whatsappId = body.data.key.remoteJid;\nconst messageText = body.data.message?.conversation || \n                   body.data.message?.extendedTextMessage?.text || '';\n\n// Extrair nÃºmero de telefone\nconst phoneNumber = whatsappId.split('@')[0];\nconst phoneE164 = '+' + phoneNumber;\n\n// Verificar se Ã© um grupo (grupos terminam com @g.us)\nif (whatsappId.includes('@g.us')) {\n  return {\n    error: true,\n    message: 'Mensagens de grupo nÃ£o sÃ£o suportadas',\n    isGroup: true\n  };\n}\n\n// Extrair comando da mensagem\nconst command = messageText.toLowerCase().trim();\n\nreturn {\n  error: false,\n  whatsapp_id: whatsappId,\n  telefone_e164: phoneE164,\n  telefone_numero: phoneNumber,\n  message_text: messageText,\n  command: command,\n  timestamp: new Date().toISOString(),\n  raw_data: body\n};"
      },
      "id": "process-whatsapp-data",
      "name": "Processar Dados WhatsApp",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [460, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.error }}",
              "value2": false
            }
          ]
        }
      },
      "id": "validate-data",
      "name": "Validar Dados",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [680, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    u.id, u.tenant_id, u.nome, u.email, u.telefone_e164,\n    u.perfil, u.status, u.email_verificado, u.criado_em,\n    t.nome_fantasia as tenant_nome, t.status as tenant_status,\n    CASE \n        WHEN u.id IS NOT NULL THEN true \n        ELSE false \n    END as usuario_existe\nFROM public.usuarios u\nLEFT JOIN public.tenants t ON u.tenant_id = t.id\nWHERE u.telefone_e164 = '{{ $json.telefone_e164 }}'\n    AND u.status = 'ativo'\n    AND t.status = 'ativo'\nLIMIT 1;",
        "additionalFields": {}
      },
      "id": "find-user",
      "name": "Buscar UsuÃ¡rio",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [900, 200],
      "credentials": {
        "postgres": {
          "id": "postgres-gestasaas",
          "name": "PostgreSQL GestaSaaS"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.usuario_existe }}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-user-exists",
      "name": "UsuÃ¡rio Existe?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1120, 200]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "command",
              "value": "={{ $('Processar Dados WhatsApp').item.json.command }}"
            },
            {
              "name": "user_id",
              "value": "={{ $json.id }}"
            },
            {
              "name": "tenant_id",
              "value": "={{ $json.tenant_id }}"
            },
            {
              "name": "user_name",
              "value": "={{ $json.nome }}"
            },
            {
              "name": "telefone_e164",
              "value": "={{ $('Processar Dados WhatsApp').item.json.telefone_e164 }}"
            },
            {
              "name": "message_text",
              "value": "={{ $('Processar Dados WhatsApp').item.json.message_text }}"
            }
          ]
        },
        "options": {}
      },
      "id": "prepare-user-data",
      "name": "Preparar Dados UsuÃ¡rio",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [1340, 100]
    },
    {
      "parameters": {
        "dataPropertyName": "data",
        "value1": "={{ $json.command }}",
        "rules": {
          "rules": [
            {
              "value2": "menu",
              "output": 0
            },
            {
              "value2": "ajuda",
              "output": 0
            },
            {
              "value2": "help",
              "output": 0
            },
            {
              "value2": "listar transacoes",
              "output": 1
            },
            {
              "value2": "transacoes",
              "output": 1
            },
            {
              "value2": "extrato",
              "output": 1
            },
            {
              "value2": "adicionar transacao",
              "output": 2
            },
            {
              "value2": "nova transacao",
              "output": 2
            },
            {
              "value2": "cadastrar gasto",
              "output": 2
            },
            {
              "value2": "editar transacao",
              "output": 3
            },
            {
              "value2": "alterar transacao",
              "output": 3
            },
            {
              "value2": "excluir transacao",
              "output": 4
            },
            {
              "value2": "deletar transacao",
              "output": 4
            },
            {
              "value2": "relatorio",
              "output": 5
            },
            {
              "value2": "resumo",
              "output": 5
            },
            {
              "value2": "meu perfil",
              "output": 6
            },
            {
              "value2": "perfil",
              "output": 6
            },
            {
              "value2": "dados",
              "output": 6
            }
          ]
        },
        "fallbackOutput": 7
      },
      "id": "command-switch",
      "name": "Switch Comandos",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [1560, 100]
    },
    {
      "parameters": {
        "model": "gpt-4",
        "messages": {
          "messageValues": [
            {
              "role": "system",
              "message": "VocÃª Ã© um assistente virtual do GestaSaaS, um sistema de gestÃ£o financeira para motoristas de aplicativo. Seu nome Ã© Sofia.\n\nContexto do usuÃ¡rio:\n- Nome: {{ $json.user_name }}\n- Telefone: {{ $json.telefone_e164 }}\n- Tenant ID: {{ $json.tenant_id }}\n\nVocÃª deve:\n1. Ser amigÃ¡vel e profissional\n2. Ajudar com comandos do sistema\n3. Explicar funcionalidades\n4. Orientar sobre uso correto\n5. Sempre manter o contexto do usuÃ¡rio\n\nComandos disponÃ­veis:\n- 'menu' ou 'ajuda': Mostrar menu principal\n- 'transacoes' ou 'extrato': Listar transaÃ§Ãµes\n- 'nova transacao': Adicionar transaÃ§Ã£o\n- 'editar transacao': Modificar transaÃ§Ã£o\n- 'excluir transacao': Remover transaÃ§Ã£o\n- 'relatorio': Gerar relatÃ³rio financeiro\n- 'perfil': Ver dados do perfil\n\nSempre termine suas respostas sugerindo um prÃ³ximo comando Ãºtil."
            },
            {
              "role": "user",
              "message": "{{ $json.message_text }}"
            }
          ]
        },
        "options": {
          "temperature": 0.7,
          "maxTokens": 500
        }
      },
      "id": "ai-assistant",
      "name": "Assistente IA",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [1780, 500],
      "credentials": {
        "openAiApi": {
          "id": "openai-gestasaas",
          "name": "OpenAI GestaSaaS"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Gerar menu principal do sistema\nconst userName = $json.user_name || 'UsuÃ¡rio';\n\nconst menuText = `ğŸ  *Menu Principal - GestaSaaS*\n\nOlÃ¡, ${userName}! ğŸ‘‹\n\nEscolha uma das opÃ§Ãµes abaixo:\n\nğŸ’° *TransaÃ§Ãµes*\nâ€¢ Digite: *transacoes* - Ver extrato\nâ€¢ Digite: *nova transacao* - Adicionar gasto/ganho\nâ€¢ Digite: *editar transacao* - Modificar transaÃ§Ã£o\nâ€¢ Digite: *excluir transacao* - Remover transaÃ§Ã£o\n\nğŸ“Š *RelatÃ³rios*\nâ€¢ Digite: *relatorio* - Resumo financeiro\n\nğŸ‘¤ *Perfil*\nâ€¢ Digite: *perfil* - Ver meus dados\n\nâ“ *Ajuda*\nâ€¢ Digite: *ajuda* - Ver este menu novamente\n\n---\nğŸ’¡ *Dica:* VocÃª pode conversar comigo naturalmente tambÃ©m! Sou a Sofia, sua assistente virtual.`;\n\nreturn {\n  response_text: menuText,\n  response_type: 'menu',\n  user_id: $json.user_id,\n  tenant_id: $json.tenant_id,\n  telefone_e164: $json.telefone_e164\n};"
      },
      "id": "generate-menu",
      "name": "Gerar Menu",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1780, 0]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    tr.id, tr.tipo, tr.categoria, tr.descricao, \n    tr.valor_cents, tr.km, tr.data, tr.criado_em,\n    ROUND(tr.valor_cents / 100.0, 2) as valor_reais\nFROM public.transacoes tr\nWHERE tr.tenant_id = '{{ $json.tenant_id }}'\n    AND tr.usuario_id = '{{ $json.user_id }}'\nORDER BY tr.data DESC, tr.criado_em DESC\nLIMIT 10;",
        "additionalFields": {}
      },
      "id": "list-transactions",
      "name": "Listar TransaÃ§Ãµes",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [1780, 100],
      "credentials": {
        "postgres": {
          "id": "postgres-gestasaas",
          "name": "PostgreSQL GestaSaaS"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Formatar lista de transaÃ§Ãµes\nconst transactions = $input.all();\nconst userName = $('Preparar Dados UsuÃ¡rio').item.json.user_name;\n\nif (!transactions || transactions.length === 0) {\n  return {\n    response_text: `ğŸ“‹ *Extrato - GestaSaaS*\\n\\nOlÃ¡, ${userName}!\\n\\nVocÃª ainda nÃ£o possui transaÃ§Ãµes registradas.\\n\\nğŸ’¡ Para adicionar uma transaÃ§Ã£o, digite: *nova transacao*`,\n    response_type: 'empty_list',\n    user_id: $('Preparar Dados UsuÃ¡rio').item.json.user_id,\n    tenant_id: $('Preparar Dados UsuÃ¡rio').item.json.tenant_id,\n    telefone_e164: $('Preparar Dados UsuÃ¡rio').item.json.telefone_e164\n  };\n}\n\nlet responseText = `ğŸ“‹ *Extrato - Ãšltimas 10 TransaÃ§Ãµes*\\n\\nOlÃ¡, ${userName}!\\n\\n`;\n\nlet totalEntradas = 0;\nlet totalSaidas = 0;\n\ntransactions.forEach((item, index) => {\n  const tr = item.json;\n  const valor = parseFloat(tr.valor_reais);\n  const data = new Date(tr.data).toLocaleDateString('pt-BR');\n  const tipo = tr.tipo === 'entrada' ? 'ğŸ’°' : 'ğŸ’¸';\n  const valorFormatado = tr.tipo === 'entrada' ? `+R$ ${valor.toFixed(2)}` : `-R$ ${valor.toFixed(2)}`;\n  \n  if (tr.tipo === 'entrada') {\n    totalEntradas += valor;\n  } else {\n    totalSaidas += valor;\n  }\n  \n  responseText += `${tipo} *${tr.categoria}* - ${data}\\n`;\n  responseText += `   ${tr.descricao}\\n`;\n  responseText += `   ${valorFormatado}`;\n  if (tr.km) {\n    responseText += ` | ${tr.km}km`;\n  }\n  responseText += `\\n\\n`;\n});\n\nconst saldo = totalEntradas - totalSaidas;\nconst saldoIcon = saldo >= 0 ? 'âœ…' : 'âš ï¸';\n\nresponseText += `ğŸ“Š *Resumo:*\\n`;\nresponseText += `ğŸ’° Entradas: R$ ${totalEntradas.toFixed(2)}\\n`;\nresponseText += `ğŸ’¸ SaÃ­das: R$ ${totalSaidas.toFixed(2)}\\n`;\nresponseText += `${saldoIcon} Saldo: R$ ${saldo.toFixed(2)}\\n\\n`;\nresponseText += `ğŸ’¡ Digite *nova transacao* para adicionar\\n`;\nresponseText += `ğŸ’¡ Digite *relatorio* para ver mais detalhes`;\n\nreturn {\n  response_text: responseText,\n  response_type: 'transaction_list',\n  user_id: $('Preparar Dados UsuÃ¡rio').item.json.user_id,\n  tenant_id: $('Preparar Dados UsuÃ¡rio').item.json.tenant_id,\n  telefone_e164: $('Preparar Dados UsuÃ¡rio').item.json.telefone_e164,\n  total_entradas: totalEntradas,\n  total_saidas: totalSaidas,\n  saldo: saldo\n};"
      },
      "id": "format-transactions",
      "name": "Formatar TransaÃ§Ãµes",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2000, 100]
    },
    {
      "parameters": {
        "functionCode": "// Guia para adicionar nova transaÃ§Ã£o\nconst userName = $json.user_name || 'UsuÃ¡rio';\n\nconst guideText = `â• *Nova TransaÃ§Ã£o - GestaSaaS*\\n\\nOlÃ¡, ${userName}!\\n\\nPara adicionar uma transaÃ§Ã£o, me envie as informaÃ§Ãµes no formato:\\n\\nğŸ“ *Formato:*\\n*Tipo: entrada/saida*\\n*Categoria: [categoria]*\\n*Valor: [valor]*\\n*DescriÃ§Ã£o: [descriÃ§Ã£o]*\\n*KM: [quilometragem]* (opcional)\\n*Data: [dd/mm/aaaa]* (opcional, padrÃ£o hoje)\\n\\nğŸ“‹ *Exemplo:*\\n*Tipo: saida*\\n*Categoria: combustivel*\\n*Valor: 85.50*\\n*DescriÃ§Ã£o: Abastecimento Posto Shell*\\n*KM: 45.2*\\n*Data: 20/10/2024*\\n\\nğŸ·ï¸ *Categorias DisponÃ­veis:*\\n\\n*Entradas:* plataforma, gorjeta, bonus, outros_ganhos\\n*SaÃ­das:* combustivel, manutencao, taxas, pedagio, alimentacao, estacionamento, outros_gastos\\n\\nğŸ’¡ Ou converse comigo naturalmente que eu te ajudo!`;\n\nreturn {\n  response_text: guideText,\n  response_type: 'add_transaction_guide',\n  user_id: $json.user_id,\n  tenant_id: $json.tenant_id,\n  telefone_e164: $json.telefone_e164\n};"
      },
      "id": "add-transaction-guide",
      "name": "Guia Nova TransaÃ§Ã£o",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1780, 200]
    },
    {
      "parameters": {
        "functionCode": "// Guia para editar transaÃ§Ã£o\nconst userName = $json.user_name || 'UsuÃ¡rio';\n\nconst guideText = `âœï¸ *Editar TransaÃ§Ã£o - GestaSaaS*\\n\\nOlÃ¡, ${userName}!\\n\\nPara editar uma transaÃ§Ã£o, primeiro vou listar suas transaÃ§Ãµes recentes.\\n\\nDepois me informe:\\n\\nğŸ“ *Formato:*\\n*Editar: [nÃºmero da transaÃ§Ã£o]*\\n*Campo: [campo a alterar]*\\n*Novo valor: [novo valor]*\\n\\nğŸ“‹ *Exemplo:*\\n*Editar: 1*\\n*Campo: valor*\\n*Novo valor: 95.50*\\n\\nğŸ”§ *Campos editÃ¡veis:*\\nâ€¢ tipo (entrada/saida)\\nâ€¢ categoria\\nâ€¢ valor\\nâ€¢ descriÃ§Ã£o\\nâ€¢ km\\nâ€¢ data\\n\\nğŸ’¡ Primeiro digite *transacoes* para ver a lista!`;\n\nreturn {\n  response_text: guideText,\n  response_type: 'edit_transaction_guide',\n  user_id: $json.user_id,\n  tenant_id: $json.tenant_id,\n  telefone_e164: $json.telefone_e164\n};"
      },
      "id": "edit-transaction-guide",
      "name": "Guia Editar TransaÃ§Ã£o",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1780, 300]
    },
    {
      "parameters": {
        "functionCode": "// Guia para excluir transaÃ§Ã£o\nconst userName = $json.user_name || 'UsuÃ¡rio';\n\nconst guideText = `ğŸ—‘ï¸ *Excluir TransaÃ§Ã£o - GestaSaaS*\\n\\nOlÃ¡, ${userName}!\\n\\nPara excluir uma transaÃ§Ã£o, primeiro vou listar suas transaÃ§Ãµes recentes.\\n\\nDepois me informe:\\n\\nğŸ“ *Formato:*\\n*Excluir: [nÃºmero da transaÃ§Ã£o]*\\n\\nğŸ“‹ *Exemplo:*\\n*Excluir: 3*\\n\\nâš ï¸ *AtenÃ§Ã£o:*\\nEsta aÃ§Ã£o nÃ£o pode ser desfeita!\\n\\nğŸ’¡ Primeiro digite *transacoes* para ver a lista!`;\n\nreturn {\n  response_text: guideText,\n  response_type: 'delete_transaction_guide',\n  user_id: $json.user_id,\n  tenant_id: $json.tenant_id,\n  telefone_e164: $json.telefone_e164\n};"
      },
      "id": "delete-transaction-guide",
      "name": "Guia Excluir TransaÃ§Ã£o",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1780, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    tr.tipo,\n    tr.categoria,\n    COUNT(*) as quantidade,\n    SUM(tr.valor_cents) as total_cents,\n    ROUND(SUM(tr.valor_cents) / 100.0, 2) as total_reais,\n    ROUND(AVG(tr.valor_cents) / 100.0, 2) as media_reais\nFROM public.transacoes tr\nWHERE tr.tenant_id = '{{ $json.tenant_id }}'\n    AND tr.usuario_id = '{{ $json.user_id }}'\n    AND tr.data >= CURRENT_DATE - INTERVAL '30 days'\nGROUP BY tr.tipo, tr.categoria\nORDER BY tr.tipo, total_cents DESC;",
        "additionalFields": {}
      },
      "id": "generate-report",
      "name": "Gerar RelatÃ³rio",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [1780, 600],
      "credentials": {
        "postgres": {
          "id": "postgres-gestasaas",
          "name": "PostgreSQL GestaSaaS"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Formatar relatÃ³rio financeiro\nconst data = $input.all();\nconst userName = $('Preparar Dados UsuÃ¡rio').item.json.user_name;\n\nif (!data || data.length === 0) {\n  return {\n    response_text: `ğŸ“Š *RelatÃ³rio Financeiro - GestaSaaS*\\n\\nOlÃ¡, ${userName}!\\n\\nVocÃª nÃ£o possui transaÃ§Ãµes nos Ãºltimos 30 dias.\\n\\nğŸ’¡ Digite *nova transacao* para comeÃ§ar!`,\n    response_type: 'empty_report',\n    user_id: $('Preparar Dados UsuÃ¡rio').item.json.user_id,\n    tenant_id: $('Preparar Dados UsuÃ¡rio').item.json.tenant_id,\n    telefone_e164: $('Preparar Dados UsuÃ¡rio').item.json.telefone_e164\n  };\n}\n\nlet responseText = `ğŸ“Š *RelatÃ³rio Financeiro - Ãšltimos 30 dias*\\n\\nOlÃ¡, ${userName}!\\n\\n`;\n\nlet totalEntradas = 0;\nlet totalSaidas = 0;\nlet entradas = [];\nlet saidas = [];\n\ndata.forEach(item => {\n  const row = item.json;\n  if (row.tipo === 'entrada') {\n    totalEntradas += parseFloat(row.total_reais);\n    entradas.push(row);\n  } else {\n    totalSaidas += parseFloat(row.total_reais);\n    saidas.push(row);\n  }\n});\n\n// Entradas\nif (entradas.length > 0) {\n  responseText += `ğŸ’° *ENTRADAS:*\\n`;\n  entradas.forEach(item => {\n    responseText += `â€¢ ${item.categoria}: R$ ${item.total_reais} (${item.quantidade}x)\\n`;\n  });\n  responseText += `*Total Entradas: R$ ${totalEntradas.toFixed(2)}*\\n\\n`;\n}\n\n// SaÃ­das\nif (saidas.length > 0) {\n  responseText += `ğŸ’¸ *SAÃDAS:*\\n`;\n  saidas.forEach(item => {\n    responseText += `â€¢ ${item.categoria}: R$ ${item.total_reais} (${item.quantidade}x)\\n`;\n  });\n  responseText += `*Total SaÃ­das: R$ ${totalSaidas.toFixed(2)}*\\n\\n`;\n}\n\n// Resumo\nconst saldo = totalEntradas - totalSaidas;\nconst saldoIcon = saldo >= 0 ? 'âœ…' : 'âš ï¸';\n\nresponseText += `ğŸ“ˆ *RESUMO GERAL:*\\n`;\nresponseText += `ğŸ’° Total Entradas: R$ ${totalEntradas.toFixed(2)}\\n`;\nresponseText += `ğŸ’¸ Total SaÃ­das: R$ ${totalSaidas.toFixed(2)}\\n`;\nresponseText += `${saldoIcon} Saldo LÃ­quido: R$ ${saldo.toFixed(2)}\\n\\n`;\n\nif (saldo < 0) {\n  responseText += `âš ï¸ *AtenÃ§Ã£o:* Suas saÃ­das estÃ£o maiores que as entradas!\\n\\n`;\n}\n\nresponseText += `ğŸ’¡ Digite *transacoes* para ver detalhes\\n`;\nresponseText += `ğŸ’¡ Digite *menu* para outras opÃ§Ãµes`;\n\nreturn {\n  response_text: responseText,\n  response_type: 'financial_report',\n  user_id: $('Preparar Dados UsuÃ¡rio').item.json.user_id,\n  tenant_id: $('Preparar Dados UsuÃ¡rio').item.json.tenant_id,\n  telefone_e164: $('Preparar Dados UsuÃ¡rio').item.json.telefone_e164,\n  total_entradas: totalEntradas,\n  total_saidas: totalSaidas,\n  saldo: saldo\n};"
      },
      "id": "format-report",
      "name": "Formatar RelatÃ³rio",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2000, 600]
    },
    {
      "parameters": {
        "functionCode": "// Mostrar dados do perfil do usuÃ¡rio\nconst userData = $('Buscar UsuÃ¡rio').item.json;\nconst userName = userData.nome;\n\nconst profileText = `ğŸ‘¤ *Meu Perfil - GestaSaaS*\\n\\nOlÃ¡, ${userName}!\\n\\nğŸ“‹ *Seus Dados:*\\n\\nâ€¢ *Nome:* ${userData.nome}\\nâ€¢ *Email:* ${userData.email}\\nâ€¢ *Telefone:* ${userData.telefone_e164}\\nâ€¢ *Perfil:* ${userData.perfil}\\nâ€¢ *Status:* ${userData.status}\\nâ€¢ *Email Verificado:* ${userData.email_verificado ? 'Sim' : 'NÃ£o'}\\nâ€¢ *Empresa:* ${userData.tenant_nome}\\nâ€¢ *Membro desde:* ${new Date(userData.criado_em).toLocaleDateString('pt-BR')}\\n\\nğŸ’¡ Para alterar seus dados, entre em contato com o suporte.\\n\\nğŸ’¡ Digite *menu* para voltar ao menu principal`;\n\nreturn {\n  response_text: profileText,\n  response_type: 'user_profile',\n  user_id: userData.id,\n  tenant_id: userData.tenant_id,\n  telefone_e164: $('Preparar Dados UsuÃ¡rio').item.json.telefone_e164\n};"
      },
      "id": "show-profile",
      "name": "Mostrar Perfil",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1780, 700]
    },
    {
      "parameters": {
        "functionCode": "// Resposta para usuÃ¡rio nÃ£o cadastrado\nconst phoneNumber = $('Processar Dados WhatsApp').item.json.telefone_e164;\n\nconst notFoundText = `âŒ *UsuÃ¡rio nÃ£o encontrado - GestaSaaS*\\n\\nOlÃ¡! ğŸ‘‹\\n\\nO nÃºmero ${phoneNumber} nÃ£o estÃ¡ cadastrado em nosso sistema ou estÃ¡ inativo.\\n\\nğŸ“ *Para se cadastrar:*\\n1. Acesse nosso site ou app\\n2. FaÃ§a seu registro\\n3. Confirme seu nÃºmero de telefone\\n\\nğŸ“ *Suporte:*\\nSe vocÃª jÃ¡ possui cadastro, entre em contato com nosso suporte.\\n\\nğŸ’¡ ApÃ³s o cadastro, vocÃª poderÃ¡ usar todos os recursos via WhatsApp!`;\n\nreturn {\n  response_text: notFoundText,\n  response_type: 'user_not_found',\n  telefone_e164: phoneNumber\n};"
      },
      "id": "user-not-found",
      "name": "UsuÃ¡rio NÃ£o Encontrado",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "functionCode": "// Resposta para dados invÃ¡lidos\nconst errorData = $('Processar Dados WhatsApp').item.json;\n\nlet errorText = `âŒ *Erro - GestaSaaS*\\n\\n`;\n\nif (errorData.isGroup) {\n  errorText += `Desculpe, nÃ£o atendemos mensagens de grupos.\\n\\nPor favor, me envie uma mensagem privada.`;\n} else {\n  errorText += `Dados invÃ¡lidos recebidos.\\n\\nTente novamente ou entre em contato com o suporte.`;\n}\n\nreturn {\n  response_text: errorText,\n  response_type: 'error',\n  error_details: errorData\n};"
      },
      "id": "error-response",
      "name": "Resposta de Erro",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [900, 400]
    },
    {
      "parameters": {
        "url": "={{ $json.evolution_api_url || 'https://your-evolution-api.com' }}/message/sendText/{{ $json.instance_name || 'gestasaas' }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "httpMethod": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "apikey",
              "value": "={{ $json.evolution_api_key || 'your-api-key' }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $json.telefone_e164.replace('+', '') }}"
            },
            {
              "name": "text",
              "value": "={{ $json.response_text }}"
            }
          ]
        },
        "options": {}
      },
      "id": "send-whatsapp-message",
      "name": "Enviar Mensagem WhatsApp",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [2220, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"success\": true, \"message\": \"Mensagem processada com sucesso\", \"timestamp\": new Date().toISOString() } }}"
      },
      "id": "webhook-response",
      "name": "Resposta Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2440, 300]
    }
  ],
  "connections": {
    "Webhook WhatsApp": {
      "main": [
        [
          {
            "node": "Processar Dados WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Dados WhatsApp": {
      "main": [
        [
          {
            "node": "Validar Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Dados": {
      "main": [
        [
          {
            "node": "Buscar UsuÃ¡rio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Resposta de Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar UsuÃ¡rio": {
      "main": [
        [
          {
            "node": "UsuÃ¡rio Existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "UsuÃ¡rio Existe?": {
      "main": [
        [
          {
            "node": "Preparar Dados UsuÃ¡rio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "UsuÃ¡rio NÃ£o Encontrado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Dados UsuÃ¡rio": {
      "main": [
        [
          {
            "node": "Switch Comandos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Comandos": {
      "main": [
        [
          {
            "node": "Gerar Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Listar TransaÃ§Ãµes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Guia Nova TransaÃ§Ã£o",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Guia Editar TransaÃ§Ã£o",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Guia Excluir TransaÃ§Ã£o",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Gerar RelatÃ³rio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mostrar Perfil",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Assistente IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Listar TransaÃ§Ãµes": {
      "main": [
        [
          {
            "node": "Formatar TransaÃ§Ãµes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gerar RelatÃ³rio": {
      "main": [
        [
          {
            "node": "Formatar RelatÃ³rio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gerar Menu": {
      "main": [
        [
          {
            "node": "Enviar Mensagem WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatar TransaÃ§Ãµes": {
      "main": [
        [
          {
            "node": "Enviar Mensagem WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guia Nova TransaÃ§Ã£o": {
      "main": [
        [
          {
            "node": "Enviar Mensagem WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guia Editar TransaÃ§Ã£o": {
      "main": [
        [
          {
            "node": "Enviar Mensagem WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guia Excluir TransaÃ§Ã£o": {
      "main": [
        [
          {
            "node": "Enviar Mensagem WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatar RelatÃ³rio": {
      "main": [
        [
          {
            "node": "Enviar Mensagem WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mostrar Perfil": {
      "main": [
        [
          {
            "node": "Enviar Mensagem WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Assistente IA": {
      "main": [
        [
          {
            "node": "Enviar Mensagem WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "UsuÃ¡rio NÃ£o Encontrado": {
      "main": [
        [
          {
            "node": "Enviar Mensagem WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resposta de Erro": {
      "main": [
        [
          {
            "node": "Enviar Mensagem WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Mensagem WhatsApp": {
      "main": [
        [
          {
            "node": "Resposta Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "id": "gestasaas",
      "name": "GestaSaaS"
    },
    {
      "id": "whatsapp",
      "name": "WhatsApp"
    },
    {
      "id": "database",
      "name": "Database"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-10-20T18:36:00.000Z",
  "versionId": "1"
}